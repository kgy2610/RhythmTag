<!-- blog/templates/blog/post_list.html -->

{% extends 'blog/base.html' %}
{% load static %}

{% block title %}ê²Œì‹œê¸€ ëª©ë¡ - RhythmTag{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'blog/css/post_list.css' %}">
{% endblock %}

{% block content %}
    <!-- ë©”ì‹œì§€ í‘œì‹œ -->
    {% if messages %}
    <div class="message-container">
        {% for message in messages %}
        <div class="message message-{{ message.tags }}">
            {{ message }}
            <button class="message-close" onclick="this.parentElement.remove()">&times;</button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- ê²€ìƒ‰ì°½ -->
    <div class="search-bar">
        <form method="get">
            <input type="text" name="search" value="{{ request.GET.search }}" 
                   placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”(ì œëª©, íƒœê·¸)">
            <input type="hidden" name="filter" value="{{ current_filter }}">
        </form>
    </div>

    <!-- ë¸”ë¡œê·¸ ì´ë¦„ -->
    <div style="text-align: center; margin: 30px 0;">
        <h2 class="blog-name">{{ blog_name }}</h2>
    </div>

    <!-- ì¹´í…Œê³ ë¦¬ ë©”ë‰´ì™€ ìƒˆ ê¸€ ì“°ê¸° -->
    <div id="category">
        <div class="category-btn">
            <input type="radio" id="my" name="filter" {% if current_filter == 'my' %}checked{% endif %}>
            <label for="my" onclick="location.href='?filter=my'">ë‚´ê°€ ì‘ì„±í•œ ê¸€</label>
            
            <input type="radio" id="follow" name="filter" {% if current_filter == 'follow' %}checked{% endif %}>
            <label for="follow" onclick="location.href='?filter=follow'">íŒ”ë¡œì›Œ/íŒ”ë¡œì‰</label>
            
            <input type="radio" id="famous" name="filter" {% if current_filter == 'famous' %}checked{% endif %}>
            <label for="famous" onclick="location.href='?filter=famous'">ì¸ê¸°ê°€ ë§ì€ ê¸€</label>
        </div>
        <div class="write">
            <p><a href="{% url 'post_write' %}">ìƒˆ ê¸€ ì“°ê¸°</a></p>
        </div>
    </div>

    <!-- ê²Œì‹œê¸€ ëª©ë¡ ë˜ëŠ” ì•ˆë‚´ ë©”ì‹œì§€ -->
    {% if current_filter == 'my' and user.is_authenticated %}
        <!-- "ë‚´ê°€ ì‘ì„±í•œ ê¸€" íƒ­ -->
        {% if not user_has_blog %}
            <!-- ë¸”ë¡œê·¸ê°€ ì—†ëŠ” ê²½ìš° -->
            <div class="no-content-message">
                <h3>ë¸”ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</h3>
                <p>ë‚˜ë§Œì˜ ë¸”ë¡œê·¸ë¥¼ ë§Œë“¤ì–´ ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
                <a href="{% url 'blog_create' %}" class="create-blog-btn">ğŸ“ ë¸”ë¡œê·¸ ìƒì„±í•˜ê¸°</a>
            </div>
        {% elif not posts %}
            <!-- ë¸”ë¡œê·¸ëŠ” ìˆì§€ë§Œ ë‚´ê°€ ì“´ ê¸€ì´ ì—†ëŠ” ê²½ìš° -->
            <div class="no-content-message">
                <h3>ì•„ì§ ì‘ì„±í•œ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</h3>
                <p>ì²« ë²ˆì§¸ ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
                <a href="{% url 'post_write' %}" class="write-first-btn">âœï¸ ì²« ë²ˆì§¸ ê¸€ ì‘ì„±í•˜ê¸°</a>
            </div>
        {% else %}
            <!-- ë‚´ê°€ ì“´ ê¸€ ëª©ë¡ í‘œì‹œ -->
            <div id="post-list">
                {% for post in posts %}
                <div class="post-card">
                    <a href="{% url 'post_detail' post.pk %}">
                        <div id="thumnail">
                            {% if post.youtube_thumbnail_url %}
                                <img src="{{ post.youtube_thumbnail_url }}" alt="{{ post.title }}">
                            {% else %}
                                <div style="background-color: whitesmoke; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #999;">ì¸ë„¤ì¼ ì—†ìŒ</div>
                            {% endif %}
                        </div>
                        <div id="info">
                            <span>{{ post.title|truncatechars:20 }}</span>
                            <div id="likes">
                                {% if user.is_authenticated %}
                                    <button class="like-btn" 
                                            data-post-id="{{ post.id }}" 
                                            data-liked="{{ post.user_liked|yesno:'true,false' }}">
                                        {% if post.user_liked %}
                                            â¤ï¸ {{ post.like_count }}
                                        {% else %}
                                            ğŸ¤ {{ post.like_count }}
                                        {% endif %}
                                    </button>
                                {% else %}
                                    â¤ï¸ {{ post.like_count }}
                                {% endif %}
                            </div>
                        </div>
                        <div id="post-content">
                            {{ post.content|striptags|truncatewords:8|safe }}
                        </div>
                        <div id="tags">
                            {% for tag in post.tags.all %}
                                <a href="?search=%23{{ tag.name }}" class="tag-item" onclick="event.stopPropagation();">
                                    #{{ tag.name }}
                                </a>
                            {% empty %}
                                <span class="no-tags">íƒœê·¸ ì—†ìŒ</span>
                            {% endfor %}
                        </div>
                    </a>
                </div>
                {% endfor %}
            </div>
        {% endif %}
    {% elif current_filter == 'follow' and user.is_authenticated %}
        <!-- "íŒ”ë¡œì›Œ/íŒ”ë¡œì‰" íƒ­ (ë¡œê·¸ì¸ëœ ì‚¬ìš©ì) -->
        {% if not posts %}
            <!-- íŒ”ë¡œìš° ì¤‘ì¸ ì‚¬ëŒì˜ ê¸€ì´ ì—†ëŠ” ê²½ìš° -->
            <div class="no-content-message">
                <h3>ğŸ‘¥ í˜„ì¬ íŒ”ë¡œìš° ì¤‘ì¸ ì‚¬ëŒì´ ì—†ìŠµë‹ˆë‹¤</h3>
                <p>ê²Œì‹œê¸€ì„ ë‘˜ëŸ¬ë³´ê³  ë§ˆìŒì— ë“œëŠ” ì‚¬ìš©ìë¥¼ íŒ”ë¡œìš° í•´ë³´ì„¸ìš”!</p>
                <a href="?filter=famous" class="explore-btn">ğŸ”¥ ì¸ê¸° ê²Œì‹œê¸€ ë‘˜ëŸ¬ë³´ê¸°</a>
            </div>
        {% else %}
            <!-- íŒ”ë¡œìš° ì¤‘ì¸ ì‚¬ëŒë“¤ì˜ ê¸€ ëª©ë¡ í‘œì‹œ -->
            <div id="post-list">
                {% for post in posts %}
                <div class="post-card">
                    <a href="{% url 'post_detail' post.pk %}">
                        <div id="thumnail">
                            {% if post.youtube_thumbnail_url %}
                                <img src="{{ post.youtube_thumbnail_url }}" alt="{{ post.title }}">
                            {% else %}
                                <div style="background-color: whitesmoke; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #999;">ì¸ë„¤ì¼ ì—†ìŒ</div>
                            {% endif %}
                        </div>
                        <div id="info">
                            <span>{{ post.title|truncatechars:18 }}</span>
                            <div id="likes">
                                {% if user.is_authenticated %}
                                    <button class="like-btn" 
                                            data-post-id="{{ post.id }}" 
                                            data-liked="{{ post.user_liked|yesno:'true,false' }}">
                                        {% if post.user_liked %}
                                            â¤ï¸ {{ post.like_count }}
                                        {% else %}
                                            ğŸ¤ {{ post.like_count }}
                                        {% endif %}
                                    </button>
                                {% else %}
                                    â¤ï¸ {{ post.like_count }}
                                {% endif %}
                            </div>
                        </div>
                        <div id="post-content">
                            {{ post.content|striptags|truncatewords:8|safe }}
                        </div>
                        <div id="tags">
                            {% for tag in post.tags.all %}
                                <a href="?search=%23{{ tag.name }}" class="tag-item" onclick="event.stopPropagation();">
                                    #{{ tag.name }}
                                </a>
                            {% empty %}
                                <span class="no-tags">íƒœê·¸ ì—†ìŒ</span>
                            {% endfor %}
                        </div>
                    </a>
                </div>
                {% endfor %}
            </div>
        {% endif %}
    {% elif current_filter == 'my' or current_filter == 'follow' %}
        <!-- ë¡œê·¸ì¸ì´ í•„ìš”í•œ íƒ­ì— ë¹„ë¡œê·¸ì¸ ì‚¬ìš©ìê°€ ì ‘ê·¼í•œ ê²½ìš° -->
        <div class="no-content-message">
            <h3>ğŸ” ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</h3>
            <p>{{ current_filter|yesno:'ë‚´ê°€ ì‘ì„±í•œ ê¸€,íŒ”ë¡œì›Œ/íŒ”ë¡œì‰' }} ê¸°ëŠ¥ì„ ì´ìš©í•˜ë ¤ë©´ ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.</p>
            <a href="{% url 'login' %}" class="login-btn">ğŸ”‘ ë¡œê·¸ì¸í•˜ê¸°</a>
        </div>
    {% else %}
        <!-- ë‹¤ë¥¸ íƒ­ë“¤ (ì¸ê¸°ê°€ ë§ì€ ê¸€ ë“±) -->
        {% if not posts %}
            <div class="no-content-message">
                <h3>ì•„ì§ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</h3>
                <p>ì²« ë²ˆì§¸ ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
            </div>
        {% else %}
            <div id="post-list">
                {% for post in posts %}
                <div class="post-card">
                    <a href="{% url 'post_detail' post.pk %}">
                        <div id="thumnail">
                            {% if post.youtube_thumbnail_url %}
                                <img src="{{ post.youtube_thumbnail_url }}" alt="{{ post.title }}">
                            {% else %}
                                <div style="background-color: whitesmoke; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #999;">ì¸ë„¤ì¼ ì—†ìŒ</div>
                            {% endif %}
                        </div>
                        <div id="info">
                            <span>{{ post.title|truncatechars:18 }}</span>
                            <div id="likes">
                                {% if user.is_authenticated %}
                                    <button class="like-btn" 
                                            data-post-id="{{ post.id }}" 
                                            data-liked="{{ post.user_liked|yesno:'true,false' }}">
                                        {% if post.user_liked %}
                                            â¤ï¸ {{ post.like_count }}
                                        {% else %}
                                            ğŸ¤ {{ post.like_count }}
                                        {% endif %}
                                    </button>
                                {% else %}
                                    â¤ï¸ {{ post.like_count }}
                                {% endif %}
                            </div>
                        </div>
                        <div id="post-content">
                            {{ post.content|striptags|truncatewords:8|safe }}
                        </div>
                        <div id="tags">
                            {% for tag in post.tags.all %}
                                <a href="?search=%23{{ tag.name }}" class="tag-item" onclick="event.stopPropagation();">
                                    #{{ tag.name }}
                                </a>
                            {% empty %}
                                <span class="no-tags">íƒœê·¸ ì—†ìŒ</span>
                            {% endfor %}
                        </div>
                    </a>
                </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endif %}
        <!-- ë¡œê·¸ì¸ í•„ìš” ì•Œë¦¼ ëª¨ë‹¬ -->
        <div id="loginModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; text-align: center;">
                <h3>ğŸ” ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</h3>
                <p id="modalMessage"></p>
                <div style="margin-top: 15px;">
                    <a href="{% url 'login' %}" style="background: #007bff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; margin-right: 10px;">ë¡œê·¸ì¸í•˜ê¸°</a>
                    <button onclick="closeLoginModal()" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px;">ë‹«ê¸°</button>
                </div>
            </div>
        </div>
    {% endblock %}

    <script>
    setTimeout(function() {
        const messageContainer = document.querySelector('.message-container');
        if (messageContainer) {
            messageContainer.style.opacity = '0';
            setTimeout(() => messageContainer.remove(), 300);
        }
    }, 3000);

    // ë¡œê·¸ì¸ í•„ìš” ì•Œë¦¼ ëª¨ë‹¬
    function showLoginRequired(tabName) {
        const modal = document.getElementById('loginModal');
        const message = document.getElementById('modalMessage');
        message.textContent = `${tabName} ê¸°ëŠ¥ì„ ì´ìš©í•˜ë ¤ë©´ ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.`;
        modal.style.display = 'block';
    }

    function closeLoginModal() {
        document.getElementById('loginModal').style.display = 'none';
    }

    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    document.getElementById('loginModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeLoginModal();
        }
    });
    </script>
</html>