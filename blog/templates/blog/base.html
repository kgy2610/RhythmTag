{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}RhythmTag{% endblock %}</title>
    <link rel="stylesheet" href="{% static 'blog/css/common.css' %}">
    {% block extra_css %}
    {% endblock %}
</head>
<body>
    <!-- ê³µí†µ í—¤ë” -->
    <header>
        <div id="header">
            <div id="logo">
                <img src="{% static 'blog/images/logo.png' %}" alt="RhythmTag" onclick="location.href='{% url 'post_list' %}'">
            </div>
            <div class="menu">
                {% if user.is_authenticated %}
                    <!-- ë¡œê·¸ì¸ëœ ì‚¬ìš©ìž ë©”ë‰´ -->
                    <div id="user" class="dropdown">
                        <img src="{% static 'blog/images/user.png' %}" alt="ë‚´ ì •ë³´" onclick="toggleUserMenu()">
                        <div id="user-dropdown" class="dropdown-content">
                            <span class="user-name">{{ user.nickname }}ë‹˜</span>
                            <a href="{% url 'user_profile' %}">ë‚´ ì •ë³´</a>
                            <hr style="margin: 5px 0; border: none; border-top: 1px solid #eee;">
                            
                            <form method="post" action="{% url 'logout' %}" style="margin: 0;">
                                {% csrf_token %}
                                <button type="submit" class="logout-btn" onclick="return confirmLogout()">
                                    ë¡œê·¸ì•„ì›ƒ
                                </button>
                            </form>
                        </div>
                    </div>
                {% else %}
                <!-- ë¹„ë¡œê·¸ì¸ ì‚¬ìš©ìž -->
                <div id="user">
                    <img src="{% static 'blog/images/user.png' %}" alt="ë¡œê·¸ì¸" onclick="location.href='{% url 'login' %}'">
                </div>
                {% endif %}
            </div>
        </div>
        <hr>
    </header>

    <!-- ë©”ì‹œì§€ í‘œì‹œ -->
    {% if messages %}
        <div id="messages">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- ê° íŽ˜ì´ì§€ë³„ ë‚´ìš© -->
    <main>
        {% block content %}
        {% endblock %}
    </main>

    <!-- ìˆ˜ì •: extra_js ë¸”ë¡ì„ </body> íƒœê·¸ ì•žìœ¼ë¡œ ì´ë™ -->
    {% block extra_js %}
        <script>
            // ì‚¬ìš©ìž ë©”ë‰´ í† ê¸€
            function toggleUserMenu() {
                const dropdown = document.getElementById('user-dropdown');
                const isVisible = dropdown.style.display === 'block';
                
                // ëª¨ë“  ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
                closeAllDropdowns();
                
                // í˜„ìž¬ ë“œë¡­ë‹¤ìš´ í† ê¸€
                if (!isVisible) {
                    dropdown.style.display = 'block';
                }
            }

            // ë©”ì¸ ë©”ë‰´ í† ê¸€
            function toggleMainMenu() {
                const dropdown = document.getElementById('menu-dropdown');
                const isVisible = dropdown.style.display === 'block';
                
                // ëª¨ë“  ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
                closeAllDropdowns();
                
                // í˜„ìž¬ ë“œë¡­ë‹¤ìš´ í† ê¸€
                if (!isVisible) {
                    dropdown.style.display = 'block';
                }
            }

            // ëª¨ë“  ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
            function closeAllDropdowns() {
                const dropdowns = document.querySelectorAll('.dropdown-content');
                dropdowns.forEach(dropdown => {
                    dropdown.style.display = 'none';
                });
            }

            // ì™¸ë¶€ í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
            document.addEventListener('click', function(event) {
                if (!event.target.closest('.dropdown')) {
                    closeAllDropdowns();
                }
            });

            // ë¡œê³  í´ë¦­ ì»¤ì„œ ìŠ¤íƒ€ì¼
            document.querySelector('#logo img').style.cursor = 'pointer';


            // ì¢‹ì•„ìš” ë²„íŠ¼ Ajax ì²˜ë¦¬
            document.addEventListener('DOMContentLoaded', function() {
                const likeButtons = document.querySelectorAll('.like-btn');
                
                likeButtons.forEach(button => {
                    button.addEventListener('click', function(e) {
                        e.preventDefault();
                        
                        const postId = this.dataset.postId;
                        const isLiked = this.dataset.liked === 'true';
                        
                        fetch(`/blog/post/${postId}/like/`, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                                'X-Requested-With': 'XMLHttpRequest',
                                'Content-Type': 'application/json',
                            },
                            credentials: 'same-origin'
                        })
                        .then(response => response.json())
                        .then(data => {
                            // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                            if (data.is_liked) {
                                this.innerHTML = `â¤ï¸ ${data.like_count}`;
                                this.dataset.liked = 'true';
                            } else {
                                this.innerHTML = `ðŸ¤ ${data.like_count}`;
                                this.dataset.liked = 'false';
                            }
                            
                            // ë©”ì‹œì§€ í‘œì‹œ (ì„ íƒì‚¬í•­)
                            console.log(data.message);
                        })
                        .catch(error => {
                            console.error('Error:', error);
                        });
                    });
                });
            });
        </script>
    {% endblock %}
</body>
</html>