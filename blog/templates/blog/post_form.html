<!-- blog/templates/blog/post_form.html -->
{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê²Œì‹œê¸€ ì‘ì„±</title>
    <link rel="stylesheet" href="{% static 'blog/css/common.css' %}">
    <link rel="stylesheet" href="{% static 'blog/css/post_form.css' %}">
</head>
<body>
    <header>
        <div id="header">
            <div id="logo">
                <img src="{% static 'blog/images/logo.png' %}" alt="RhythmTag">
            </div>
            <div class="menu">
                <div id="user">
                    <img src="{% static 'blog/images/user.png' %}" alt="ë‚´ ì •ë³´">
                </div>
                <div id="menu">
                    <img src="{% static 'blog/images/menu.png' %}" alt="ë©”ë‰´">
                </div>
            </div>
        </div>
        <hr>
    </header>

    <div id="title-write">
        <p>#ìƒˆ ê¸€ ì“°ê¸°</p>
    </div>
    {% if messages %}
        <div id="messages">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}" style="padding: 10px; margin: 10px; background-color: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; color: #721c24;">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <section>
        {{ form.media }}
        <form method="post" enctype="multipart/form-data" id="postForm">
            {% csrf_token %}

            <div id="write-title" class="form-group">
                <label for="{{ form.title.id_for_label }}">ì œëª© : </label>
                {{ form.title }}
                {{ form.title.errors }}
            </div>

            <div id="write-content" class="form-group">
                <small>{{ form.content.help_text }}</small>
                <label for="{{ form.content.id_for_label }}"></label>
                {{ form.content }}
                {{ form.content.errors }}
            </div>

            <div id="ai-section">
                <div class="ai-section-title">
                    <div class="ai-icon">AI</div>
                    AI ìŒì•… ë¸”ë¡œê·¸ ìë™ ìƒì„±
                </div>
                
                <div id="ai-inputs">
                    <input type="text" id="ai-artist" placeholder="ê°€ìˆ˜ëª… (ì˜ˆ: ì•„ì´ìœ )" />
                    <input type="text" id="ai-song" placeholder="ë…¸ë˜ì œëª© (ì˜ˆ: ì¢‹ì€ ë‚ )" />
                    <input type="text" id="ai-link" placeholder="ìœ íŠœë¸Œ ë§í¬" />
                </div>
                
                <button type="button" id="ai-generate-btn">ğŸµ AIë¡œ ë¸”ë¡œê·¸ ìƒì„±í•˜ê¸°</button>
                
                <div id="ai-loading">
                    <div class="loading-spinner"></div>
                    <p>AIê°€ ë©‹ì§„ ë¸”ë¡œê·¸ë¥¼ ì‘ì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤... âœ¨</p>
                </div>
            </div>

            <div id="write-link" class="form-group">
                <label for="{{ form.link.id_for_label }}">ìœ íŠœë¸Œ ë§í¬ : </label>
                {{ form.link }}
                {{ form.link.errors }}
            </div>

            <div id="write-tag" class="form-group">
                <label for="{{ form.tag_input.id_for_label }}">íƒœê·¸ ìˆ˜ì • : </label>
                {{ form.tag_input }}
                {{ form.tag_input.errors }}
                <small>{{ form.tag_input.help_text }}</small>
            </div>
            <div id="write-btn">
                <button type="submit">ì‘ì„± ì™„ë£Œ</button>
            </div>
        </form>
    </section>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ì‚¬ìš©ì ì¸ì¦ ìƒíƒœ í™•ì¸
            const isAuthenticated = {{ user.is_authenticated|yesno:"true,false" }};
            
            console.log('í˜ì´ì§€ ë¡œë“œë¨. ì¸ì¦ ìƒíƒœ:', isAuthenticated);
            
            // AI ìƒì„± ë²„íŠ¼ ì´ë²¤íŠ¸
            const aiGenerateBtn = document.getElementById('ai-generate-btn');
            const aiLoading = document.getElementById('ai-loading');
            
            aiGenerateBtn.addEventListener('click', async function() {
                // ì…ë ¥ê°’ ê°€ì ¸ì˜¤ê¸°
                const artist = document.getElementById('ai-artist').value.trim();
                const song = document.getElementById('ai-song').value.trim();
                const link = document.getElementById('ai-link').value.trim();
                
                // ì…ë ¥ê°’ ê²€ì¦
                if (!artist || !song || !link) {
                    alert('ê°€ìˆ˜ëª…, ë…¸ë˜ì œëª©, ìœ íŠœë¸Œ ë§í¬ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                // ìœ íŠœë¸Œ ë§í¬ ê²€ì¦ (ê°„ë‹¨í•œ ê²€ì¦)
                if (!link.includes('youtube.com') && !link.includes('youtu.be')) {
                    alert('ì˜¬ë°”ë¥¸ ìœ íŠœë¸Œ ë§í¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                // ë¡œë”© ìƒíƒœ í‘œì‹œ
                aiGenerateBtn.disabled = true;
                aiGenerateBtn.textContent = 'ìƒì„± ì¤‘...';
                aiLoading.style.display = 'block';
                
                try {
                    // CSRF í† í° ê°€ì ¸ì˜¤ê¸°
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                    
                    // AI ë¸”ë¡œê·¸ ìƒì„± ìš”ì²­
                    const response = await fetch('{% url "generate_ai_blog" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken,
                        },
                        body: JSON.stringify({
                            artist: artist,
                            song_title: song,
                            youtube_link: link
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.success) {
                        // CKEditorì— ë‚´ìš© ì‚½ì…
                        const contentField = document.querySelector('textarea[name="content"]') || 
                                           document.querySelector('#id_content');
                        
                        if (contentField) {
                            console.log('Content í•„ë“œ ì°¾ìŒ:', contentField.id);
                            
                            // CKEditor ì¸ìŠ¤í„´ìŠ¤ ì§ì ‘ ì ‘ê·¼
                            const editorInstance = window.CKEDITOR.instances['id_content'];
                            
                            if (editorInstance) {
                                console.log('CKEditor ì¸ìŠ¤í„´ìŠ¤ ì°¾ìŒ');
                                
                                // í…ìŠ¤íŠ¸ë¥¼ HTMLë¡œ ë³€í™˜
                                const htmlContent = data.blog_content
                                    .replace(/\n\n/g, '</p><p>')  // ë¹ˆ ì¤„ì€ ë¬¸ë‹¨ êµ¬ë¶„
                                    .replace(/\n/g, '<br>')       // ì¼ë°˜ ì¤„ë°”ê¿ˆì€ <br>
                                    .replace(/^/, '<p>')          // ì‹œì‘ì— <p> ì¶”ê°€
                                    .replace(/$/, '</p>');        // ëì— </p> ì¶”ê°€
                                
                                // ì—ë””í„°ê°€ ì¤€ë¹„ëœ ìƒíƒœì¸ì§€ í™•ì¸
                                if (editorInstance.status === 'ready') {
                                    editorInstance.setData(htmlContent);
                                    console.log('âœ“ CKEditorì— ì¦‰ì‹œ ë‚´ìš© ì‚½ì… ì„±ê³µ');
                                } else {
                                    // ì—ë””í„°ê°€ ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸°
                                    console.log('ì—ë””í„° ì¤€ë¹„ ëŒ€ê¸° ì¤‘...');
                                    editorInstance.on('instanceReady', function() {
                                        editorInstance.setData(htmlContent);
                                        console.log('âœ“ CKEditorì— ì§€ì—° ì‚½ì… ì„±ê³µ');
                                    });
                                }
                            } else {
                                console.log('CKEditor ì¸ìŠ¤í„´ìŠ¤ ì—†ìŒ, textareaì— ì§ì ‘ ì‚½ì…');
                                contentField.value = data.blog_content;
                            }
                        } else {
                            console.error('Content í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        }
                        
                        // ì œëª©ê³¼ ë§í¬ë„ ìë™ìœ¼ë¡œ ì±„ìš°ê¸°
                        const titleField = document.querySelector('input[name="title"]') || 
                                         document.querySelector('#id_title');
                        const linkField = document.querySelector('input[name="link"]') || 
                                        document.querySelector('#id_link');
                        
                        if (titleField && !titleField.value.trim()) {
                            titleField.value = `${artist} - ${song} ì¶”ì²œ`;
                        }
                        
                        if (linkField && !linkField.value.trim()) {
                            linkField.value = link;
                        }
                        
                        alert('AI ë¸”ë¡œê·¸ê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“âœ¨');
                        
                        // AI ì…ë ¥ í•„ë“œë“¤ ì´ˆê¸°í™”
                        document.getElementById('ai-artist').value = '';
                        document.getElementById('ai-song').value = '';
                        document.getElementById('ai-link').value = '';
                        
                    } else {
                        alert('ë¸”ë¡œê·¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                    }
                    
                } catch (error) {
                    console.error('AI ë¸”ë¡œê·¸ ìƒì„± ì˜¤ë¥˜:', error);
                    alert('ë¸”ë¡œê·¸ ìƒì„± ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
                
                // ë¡œë”© ìƒíƒœ í•´ì œ
                aiGenerateBtn.disabled = false;
                aiGenerateBtn.textContent = 'ğŸµ AIë¡œ ë¸”ë¡œê·¸ ìƒì„±í•˜ê¸°';
                aiLoading.style.display = 'none';
            });
            
            // ê¸°ì¡´ í¼ ì œì¶œ ì´ë²¤íŠ¸
            const form = document.getElementById('postForm');
            
            if (form) {
                form.addEventListener('submit', function(e) {
                    console.log('í¼ ì œì¶œ ì´ë²¤íŠ¸ ë°œìƒ!');
                    
                    // ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ ë§‰ê¸°
                    if (!isAuthenticated) {
                        e.preventDefault();
                        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                        window.location.href = "{% url 'login' %}";
                        return false;
                    }

                    // í¼ ë°ì´í„° ê²€ì¦
                    const title = document.querySelector('input[name="title"]').value;
                    const content = document.querySelector('textarea[name="content"]').value;
                    
                    if (!title.trim()) {
                        e.preventDefault();
                        alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                        return false;
                    }
                    
                    if (!content.trim()) {
                        e.preventDefault();
                        alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                        return false;
                    }
                    
                    console.log('í¼ ì œì¶œ ì§„í–‰');
                });
            }
        });
    </script>
</body>
</html>