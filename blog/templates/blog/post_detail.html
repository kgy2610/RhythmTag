{% extends 'blog/base.html' %}
{% load static %}

{% block title %}ë‚´ ì •ë³´ - RhythmTag{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'blog/css/common.css' %}">
    <link rel="stylesheet" href="{% static 'blog/css/post_detail.css' %}">
{% endblock %}

{% block content %}
    <div id="back-button">
        <a href="{% url 'post_list' %}" class="back-link">â† ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
    </div>
    <section>
        <div class="post-content">
            <div id="content-title">
                {{ post.title }}
            </div>
            <div class="post-author">
                <div class="view-count">ì¡°íšŒìˆ˜ : {{ post.view_count }}</div>
                <a href="{% url 'other_user_profile' user_id=post.user.id %}" style="color: #7C3AED; text-decoration: none; font-weight: 600;">
                    {{ post.user.nickname }}ë‹˜ì˜ ê²Œì‹œê¸€
                </a>
            </div>
            <div id="content-link">
                {% if youtube_embed_url %}
                <iframe width="560" height="315"
                    src="{{ youtube_embed_url }}"
                    frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen>
                </iframe>
                {% else %}
                <p>ìœ íš¨í•œ ìœ íŠœë¸Œ ë§í¬ê°€ ì•„ë‹™ë‹ˆë‹¤.</p>
                {% endif %}
            </div>
            <div id="content-text">
                {{ post.content|safe }}
            </div>
            <div id="content-tags">
                {% for tag in post.tags.all %}
                <p>
                    {{ tag.name }}
                </p>
                {% endfor %}
            </div>
        </div>

        <div class="content-reaction">
            <div id="reply-count">
                <div id="likes">
                    {% if user.is_authenticated %}
                        <button class="like-btn" 
                                data-post-id="{{ post.id }}" 
                                data-liked="{{ user_liked|yesno:'true,false' }}">
                            {% if user_liked %}
                                â¤ï¸ {{ post.like_count }}
                            {% else %}
                                ğŸ¤ {{ post.like_count }}
                            {% endif %}
                        </button>
                    {% else %}
                        <a href="{% url 'login' %}">â¤ï¸ {{ post.like_count }}</a>
                    {% endif %}
                </div>
                <div id="comment">
                    ğŸ—¨ï¸ {{ comments.count }}
                </div>
            </div>

            {% if user.is_authenticated %}
                {% if user == post.user %}
                    <div class="content-option">
                        <div id="content-update">
                            <a href="{% url 'post_update' post.id %}">ìˆ˜ì •</a>
                        </div>
                        |
                        <div id="content-delete">
                            <a href="{% url 'post_delete' post.id %}" 
                            onclick="return confirm('ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ì‚­ì œ</a>
                        </div>
                    </div>
                {% else %}
                    <!-- ë‹¤ë¥¸ ì‚¬ìš©ìì˜ ê¸€ì¼ ë•ŒëŠ” ì•„ë¬´ê²ƒë„ í‘œì‹œí•˜ì§€ ì•ŠìŒ -->
                {% endif %}
            {% else %}
                <!-- ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ê²½ìš°ë„ ì•„ë¬´ê²ƒë„ í‘œì‹œí•˜ì§€ ì•ŠìŒ -->
            {% endif %}
        </div>

        <div class="comment-area">
            {% if user.is_authenticated %}
            <div id="comment-form">
                <form id="commentForm" method="post" action="{% url 'add_comment' post.pk %}">
                    {% csrf_token %}
                    <div id="comment-input">
                        <input type="text" name="comment" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                        <button type="submit">ì‘ ì„±</button>
                    </div>
                </form>
            </div>
            {% else %}
            <div id="comment-login-message">
                <a href="{% url 'login' %}">ë¡œê·¸ì¸</a>í•˜ì—¬ ëŒ“ê¸€ì„ ì‘ì„±í•˜ì„¸ìš”.
            </div>
            {% endif %}

            <div id="comments-list">
                {% for comment in comments %}
                <div class="comment-reply" data-comment-id="{{ comment.id }}">
                    <div class="comment-content">
                        <div id="user-name">{{ comment.user.nickname }}</div>
                        |
                        <div id="user-content" class="comment-text">{{ comment.comment }}</div>
                        |
                        <div id="user-writeDate" class="date-section">
                            <div class="comment-date">{{ comment.created_at|date:"Y.m.d H:i" }}</div>
                            {% if comment.updated_at != comment.created_at %}
                                <div class="edited-mark">(ìˆ˜ì •ë¨)</div>
                            {% endif %}
                        </div>
                        
                        <!-- ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ (ì‘ì„±ìë§Œ í‘œì‹œ) -->
                        {% if user.is_authenticated and comment.user == user %}
                        <div class="comment-actions">
                            |
                            <button class="edit-btn" data-comment-id="{{ comment.id }}">ìˆ˜ì •</button>
                            <button class="delete-btn" data-comment-id="{{ comment.id }}">ì‚­ì œ</button>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- ìˆ˜ì • í¼ (ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€) -->
                    <div class="edit-form" id="edit-form-{{ comment.id }}" style="display: none;">
                        <form class="edit-comment-form" data-comment-id="{{ comment.id }}" method="post" action="{% url 'edit_comment' comment.id %}">
                            {% csrf_token %}
                            <input type="text" name="comment" value="{{ comment.comment }}" required>
                            <button type="submit">ì €ì¥</button>
                            <button type="button" class="cancel-edit" data-comment-id="{{ comment.id }}">ì·¨ì†Œ</button>
                        </form>
                    </div>
                </div>
                {% empty %}
                <div id="no-comments">
                    ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ ëŒ“ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!
                </div>
                {% endfor %}
            </div>
        </div>
    </section>
    <script>
        document.getElementById('commentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const commentInput = this.querySelector('input[name="comment"]');
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // ìƒˆ ëŒ“ê¸€ì„ í™”ë©´ì— ì¶”ê°€
                    const commentsList = document.getElementById('comments-list');
                    const noComments = document.getElementById('no-comments');
                    
                    if (noComments) {
                        noComments.remove();
                    }
                    
                    const newComment = document.createElement('div');
                    newComment.className = 'comment-reply';
                    newComment.innerHTML = `
                        <div id="user-name">${data.comment.user_nickname}</div>
                        |
                        <div id="user-content">${data.comment.comment}</div>
                        |
                        <div id="user-writeDate">${data.comment.created_at}</div>
                    `;
                    
                    commentsList.appendChild(newComment);
                    
                    // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                    commentInput.value = '';
                    
                    // ëŒ“ê¸€ ìˆ˜ ì—…ë°ì´íŠ¸
                    const commentCount = document.querySelector('#comment');
                    const currentCount = parseInt(commentCount.textContent.match(/\d+/)[0]);
                    commentCount.textContent = `ğŸ—¨ï¸ ${currentCount + 1}`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ëŒ“ê¸€ ì‘ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        });
        // ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ (ìƒˆë¡œ ì¶”ê°€)
        document.addEventListener('click', function(e) {
            // ìˆ˜ì • ë²„íŠ¼ í´ë¦­
            if (e.target.classList.contains('edit-btn')) {
                const commentId = e.target.getAttribute('data-comment-id');
                const commentContent = document.querySelector(`[data-comment-id="${commentId}"] .comment-content`);
                const editForm = document.getElementById(`edit-form-${commentId}`);
                
                commentContent.style.display = 'none';
                editForm.style.display = 'block';
            }
            
            // ìˆ˜ì • ì·¨ì†Œ ë²„íŠ¼
            if (e.target.classList.contains('cancel-edit')) {
                const commentId = e.target.getAttribute('data-comment-id');
                const commentContent = document.querySelector(`[data-comment-id="${commentId}"] .comment-content`);
                const editForm = document.getElementById(`edit-form-${commentId}`);
                
                commentContent.style.display = 'block';
                editForm.style.display = 'none';
            }
            
            // ì‚­ì œ ë²„íŠ¼ í´ë¦­ (ìˆ˜ì •ëœ ë¶€ë¶„)
            if (e.target.classList.contains('delete-btn')) {
                const commentId = e.target.getAttribute('data-comment-id');
                
                if (confirm('ì •ë§ë¡œ ì´ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                    
                    // URLì„ ì˜¬ë°”ë¥´ê²Œ ìƒì„± (ìˆ˜ì •ëœ ë¶€ë¶„)
                    const deleteUrl = "{% url 'delete_comment' 0 %}".replace('0', commentId);
                    
                    fetch(deleteUrl, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': csrfToken,
                            'Content-Type': 'application/x-www-form-urlencoded',
                        }
                    })
                    .then(response => {
                        // JSON íŒŒì‹± ì „ì— ì‘ë‹µ ìƒíƒœ í™•ì¸ (ìˆ˜ì •ëœ ë¶€ë¶„)
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            // ëŒ“ê¸€ ìš”ì†Œ ì œê±°
                            const commentElement = document.querySelector(`[data-comment-id="${commentId}"]`);
                            commentElement.remove();
                            
                            // ëŒ“ê¸€ ìˆ˜ ì—…ë°ì´íŠ¸
                            const commentCount = document.querySelector('#comment');
                            const currentCount = parseInt(commentCount.textContent.match(/\d+/)[0]);
                            const newCount = currentCount - 1;
                            commentCount.textContent = `ğŸ—¨ï¸ ${newCount}`;
                            
                            // ëŒ“ê¸€ì´ ì—†ìœ¼ë©´ ë©”ì‹œì§€ í‘œì‹œ
                            const commentsContainer = document.getElementById('comments-list');
                            if (commentsContainer.children.length === 0) {
                                commentsContainer.innerHTML = '<div id="no-comments">ì²« ë²ˆì§¸ ëŒ“ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</div>';
                            }
                        } else {
                            alert(data.error || 'ëŒ“ê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('ëŒ“ê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                    });
                }
            }
        });

        // ëŒ“ê¸€ ìˆ˜ì • í¼ ì œì¶œ ì´ë²¤íŠ¸ (ìˆ˜ì •ëœ ë¶€ë¶„)
        document.addEventListener('submit', function(e) {
            if (e.target.classList.contains('edit-comment-form')) {
                e.preventDefault();
                
                const formData = new FormData(e.target);
                const commentId = e.target.getAttribute('data-comment-id');
                
                fetch(e.target.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                    }
                })
                .then(response => {
                    // JSON íŒŒì‹± ì „ì— ì‘ë‹µ ìƒíƒœ í™•ì¸ (ìˆ˜ì •ëœ ë¶€ë¶„)
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // ëŒ“ê¸€ ë‚´ìš© ì—…ë°ì´íŠ¸
                        const commentText = document.querySelector(`[data-comment-id="${commentId}"] .comment-text`);
                        const dateSection = document.querySelector(`[data-comment-id="${commentId}"] .date-section`);
                        
                        commentText.textContent = data.comment.comment;
                        dateSection.innerHTML = `
                                                    <div class="comment-date">${data.comment.updated_at}</div>
                                                    <div class="edited-mark">(ìˆ˜ì •ë¨)</div>
                                                `;
                        
                        // ìˆ˜ì • í¼ ìˆ¨ê¸°ê³  ëŒ“ê¸€ ë‚´ìš© ë³´ì´ê¸°
                        const commentContent = document.querySelector(`[data-comment-id="${commentId}"] .comment-content`);
                        const editForm = document.getElementById(`edit-form-${commentId}`);
                        
                        commentContent.style.display = 'flex';
                        editForm.style.display = 'none';
                    } else {
                        alert(data.error || 'ëŒ“ê¸€ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('ëŒ“ê¸€ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                });
            }
        });
        </script>
{% endblock %}
