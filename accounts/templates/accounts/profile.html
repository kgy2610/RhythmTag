<!-- accounts/templates/accounts/profile.html -->
{% extends 'blog/base.html' %}
{% load static %}

{% block title %}ë‚´ ì •ë³´ - RhythmTag{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'accounts/css/profile.css' %}">
{% endblock %}

{% block content %}
<div class="profile-container">
    <!-- ì™¼ìª½ íƒ­ ë©”ë‰´ -->
    <div class="tab-menu">
        <h3>ì„¤ì •</h3>
        <button class="tab-button active" onclick="showTab('blog-info')">
            ğŸ“ ë‚´ ë¸”ë¡œê·¸ ì •ë³´
        </button>
        <button class="tab-button" onclick="showTab('profile-info')">
            ğŸ‘¤ ë‚´ í”„ë¡œí•„ ì •ë³´
        </button>
        <!-- ì¶”ê°€ëœ íŒ”ë¡œìš° íƒ­ ë©”ë‰´ -->
        <button class="tab-button" onclick="showTab('follow-info')">
            ğŸ‘¥ íŒ”ë¡œìš°
        </button>
    </div>

    <!-- ì˜¤ë¥¸ìª½ ì»¨í…ì¸  ì˜ì—­ -->
    <div class="tab-content">
        <!-- ë¸”ë¡œê·¸ ì •ë³´ íƒ­ -->
        <div id="blog-info" class="tab-pane active">
            <h2>ë‚´ ë¸”ë¡œê·¸ ì •ë³´</h2>
            
            <div class="blog-info-section">
                <div class="info-card">
                    <div class="info-item">
                        <span class="info-label">ë¸”ë¡œê·¸ ì´ë¦„:</span>
                        <span class="info-value">{{ user.blog.blog_name|default:"ë¸”ë¡œê·¸ ì´ë¦„ ì—†ìŒ" }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ë¸”ë¡œê·¸ ì„¤ëª…:</span>
                        <span class="info-value">{{ user.blog.blog_description|default:"ë¸”ë¡œê·¸ ì„¤ëª… ì—†ìŒ" }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ìƒì„±ì¼:</span>
                        <span class="info-value">{{ user.blog.created_at|date:"Yë…„ mì›” dì¼"|default:"ì •ë³´ ì—†ìŒ" }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ì´ ê²Œì‹œê¸€:</span>
                        <span class="info-value">{{ user.posts.count }}ê°œ</span>
                    </div>
                </div>

                <div class="btn-group">
                    <a href="#" class="btn btn-primary" onclick="updateBlog()">
                        âœï¸ ë¸”ë¡œê·¸ ì •ë³´ ìˆ˜ì •
                    </a>
                    <a href="#" class="btn btn-danger" onclick="deleteBlog()">
                        ğŸ—‘ï¸ ë¸”ë¡œê·¸ ì‚­ì œ
                    </a>
                </div>
            </div>

            <!-- ìµœê·¼ ê²Œì‹œê¸€ ë¯¸ë¦¬ë³´ê¸° -->
            <div class="blog-info-section">
                <h3>ìµœê·¼ ì‘ì„±í•œ ê²Œì‹œê¸€</h3>
                {% if user_posts %}
                    <div class="info-card">
                        {% for post in user_posts %}
                            <div class="info-item">
                                <span class="info-label">{{ post.created_at|date:"m/d" }}</span>
                                <span class="info-value">
                                    <a href="{% url 'post_detail' post.pk %}" style="color: #007bff; text-decoration: none;">
                                        {{ post.title }}
                                    </a>
                                </span>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="info-card">
                        <p style="text-align: center; color: #6c757d;">ì‘ì„±í•œ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        <div style="text-align: center;">
                            <a href="{% url 'post_write' %}" class="btn btn-primary">ì²« ê²Œì‹œê¸€ ì‘ì„±í•˜ê¸°</a>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- í”„ë¡œí•„ ì •ë³´ íƒ­ -->
        <div id="profile-info" class="tab-pane">
            <h2>ë‚´ í”„ë¡œí•„ ì •ë³´</h2>
            
            <div class="profile-info-section">
                <div class="info-card">
                    <div class="info-item">
                        <span class="info-label">ì‚¬ìš©ì ID:</span>
                        <span class="info-value">{{ user.userid }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ë¹„ë°€ë²ˆí˜¸:</span>
                        <span class="info-value">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ë‹‰ë„¤ì„:</span>
                        <span class="info-value">{{ user.nickname|default:"ë‹‰ë„¤ì„ ì—†ìŒ" }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ì „í™”ë²ˆí˜¸:</span>
                        <span class="info-value">{{ user.phone|default:"ì „í™”ë²ˆí˜¸ ì—†ìŒ" }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ê°€ì…ì¼:</span>
                        <span class="info-value">{{ user.created_at|date:"Yë…„ mì›” dì¼" }}</span>
                    </div>
                </div>

                <div class="security-notice">
                    <strong>ë³´ì•ˆ ì•Œë¦¼:</strong> ê°œì¸ì •ë³´ ìˆ˜ì • ì‹œ ë³¸ì¸ í™•ì¸ì„ ìœ„í•´ í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </div>

                <div class="btn-group">
                    <a href="#" class="btn btn-primary" onclick="updateProfile()">
                        âœï¸ í”„ë¡œí•„ ìˆ˜ì •
                    </a>
                    <a href="#" class="btn btn-warning" onclick="changePassword()">
                        ğŸ”’ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
                    </a>
                </div>
            </div>

            <!-- ìœ„í—˜ êµ¬ì—­ -->
            <div class="danger-zone">
                <h4>âš ï¸ ìœ„í—˜ êµ¬ì—­</h4>
                <p>ì•„ë˜ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‹ ì¤‘íˆ ê²°ì •í•´ì£¼ì„¸ìš”.</p>
                <div class="btn-group">
                    <a href="#" class="btn delete-btn-danger" onclick="deleteAccount()">
                        ğŸ—‘ï¸ íšŒì› íƒˆí‡´
                    </a>
                </div>
            </div>
        </div>

        <!-- ì¶”ê°€ëœ íŒ”ë¡œìš° ì •ë³´ íƒ­ -->
        <div id="follow-info" class="tab-pane">
            <h2>íŒ”ë¡œìš° ê´€ë¦¬</h2>
            
            <!-- íŒ”ë¡œìš° í†µê³„ -->
            <div class="follow-stats-section">
                <div class="info-card">
                    <div class="follow-stats">
                        <div class="stat-item">
                            <span class="stat-number">{{ following_count|default:0 }}</span>
                            <span class="stat-label">íŒ”ë¡œì‰</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">{{ followers_count|default:0 }}</span>
                            <span class="stat-label">íŒ”ë¡œì›Œ</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- íŒ”ë¡œì‰ ëª©ë¡ -->
            <div class="follow-section">
                <h3>ğŸ“¤ ë‚´ê°€ íŒ”ë¡œìš°í•œ ì‚¬ëŒ ({{ following_count|default:0 }}ëª…)</h3>
                {% if following_list %}
                    <div class="info-card">
                        {% for follow in following_list %}
                            <div class="follow-item">
                                <div class="follow-user-info">
                                    <span class="follow-username">{{ follow.following.nickname|default:follow.following.userid }}</span>
                                    <span class="follow-date">{{ follow.created_at|date:"Y.m.d" }} íŒ”ë¡œìš°</span>
                                </div>
                                <div class="follow-actions">
                                    <a href="{% url 'other_user_profile' follow.following.id %}" class="btn btn-sm btn-outline">
                                        í”„ë¡œí•„ ë³´ê¸°
                                    </a>
                                    <button class="btn btn-sm btn-danger" onclick="unfollowUser('{{ follow.following.userid }}')">
                                        ì–¸íŒ”ë¡œìš°
                                    </button>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="info-card">
                        <p style="text-align: center; color: #6c757d;">íŒ”ë¡œìš°í•œ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                {% endif %}
            </div>

            <!-- íŒ”ë¡œì›Œ ëª©ë¡ -->
            <div class="follow-section">
                <h3>ğŸ“¥ ë‚˜ë¥¼ íŒ”ë¡œìš°í•œ ì‚¬ëŒ ({{ followers_count|default:0 }}ëª…)</h3>
                {% if followers_list %}
                    <div class="info-card">
                        {% for follow in followers_list %}
                            <div class="follow-item">
                                <div class="follow-user-info">
                                    <span class="follow-username">{{ follow.follower.nickname|default:follow.follower.userid }}</span>
                                    <span class="follow-date">{{ follow.created_at|date:"Y.m.d" }} íŒ”ë¡œìš°í•¨</span>
                                </div>
                                <div class="follow-actions">
                                    <a href="{% url 'other_user_profile' follow.follower.id %}" class="btn btn-sm btn-outline">
                                        í”„ë¡œí•„ ë³´ê¸°
                                    </a>
                                    {% if follow.follower in following_users %}
                                        <button class="btn btn-sm btn-danger" onclick="unfollowUser('{{ follow.follower.userid }}')">
                                            ì–¸íŒ”ë¡œìš°
                                        </button>
                                    {% else %}
                                        <button class="btn btn-sm btn-primary" onclick="followUser('{{ follow.follower.userid }}')">
                                            íŒ”ë¡œìš° ë°±
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="info-card">
                        <p style="text-align: center; color: #6c757d;">ë‚˜ë¥¼ íŒ”ë¡œìš°í•œ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// íƒ­ ì „í™˜ í•¨ìˆ˜
function showTab(tabId) {
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
    });
    
    document.querySelectorAll('.tab-pane').forEach(pane => {
        pane.classList.remove('active');
    });
    
    event.target.classList.add('active');
    document.getElementById(tabId).classList.add('active');
}

// ë¸”ë¡œê·¸ ì •ë³´ ìˆ˜ì •
function updateBlog() {
    window.location.href = "{% url 'blog_update' %}";
}

// ë¸”ë¡œê·¸ ì‚­ì œ
function deleteBlog() {
    if (confirm('ì •ë§ë¡œ ë¸”ë¡œê·¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nëª¨ë“  ê²Œì‹œê¸€ì´ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.')) {
        window.location.href = "{% url 'blog_delete' %}";
    }
}

// í”„ë¡œí•„ ìˆ˜ì •
function updateProfile() {
    window.location.href = "{% url 'profile_update' %}";
}

// ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
function changePassword() {
    window.location.href = "{% url 'password_change' %}";
}

// íšŒì› íƒˆí‡´
function deleteAccount() {
    if (confirm('âš ï¸ ì •ë§ë¡œ íšŒì›íƒˆí‡´ë¥¼ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ë©° ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
        if (confirm('ğŸš¨ ë§ˆì§€ë§‰ í™•ì¸ì…ë‹ˆë‹¤. ì •ë§ë¡œ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            window.location.href = "{% url 'profile_delete' %}";
        }
    }
}

// ì¶”ê°€ëœ íŒ”ë¡œìš° ê´€ë ¨ í•¨ìˆ˜ë“¤
// ì‚¬ìš©ì íŒ”ë¡œìš°
function followUser(userid) {
    if (confirm(`${userid}ë‹˜ì„ íŒ”ë¡œìš°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        fetch(`{% url 'follow_user' 'dummy' %}`.replace('dummy', userid), {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ë³€ê²½ì‚¬í•­ ë°˜ì˜
            } else {
                alert('íŒ”ë¡œìš°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }
}

// ì‚¬ìš©ì ì–¸íŒ”ë¡œìš°
function unfollowUser(userid) {
    if (confirm(`${userid}ë‹˜ì„ ì–¸íŒ”ë¡œìš°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        fetch(`{% url 'unfollow_user' 'dummy' %}`.replace('dummy', userid), {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ë³€ê²½ì‚¬í•­ ë°˜ì˜
            } else {
                alert('ì–¸íŒ”ë¡œìš°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }
}

// CSRF í† í° ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}